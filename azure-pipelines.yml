trigger:
  branches:
    include:
    - main
pr:
  branches:
    include:
    - main

pool:
  vmImage: 'ubuntu-latest'

variables:
   commitCount: 0

stages:
  - stage: check_pr_commits_count
    displayName: Check PR Commits Count
    jobs:
      - job: check_commits
        displayName: Check Commits
        condition: eq(variables['Build.Reason'], 'PullRequest')
        steps:
          - checkout: self
            fetchDepth: 0
          - task: Bash@3
            displayName: Check PR Commit Count
            inputs:
              targetType: inline
              script: |
                git fetch origin
                SOURCE_BRANCH_NAME=$(echo $(System.PullRequest.SourceBranch))
                TARGET_BRANCH_NAME=$(echo $(System.PullRequest.TargetBranch) | sed 's/refs\/heads\///')
                echo "Source branch: $SOURCE_BRANCH_NAME"
                echo "Target branch: $TARGET_BRANCH_NAME"
                commit_count=$(git rev-list --count origin/$TARGET_BRANCH_NAME..origin/$SOURCE_BRANCH_NAME)
                echo "Commit count: $commit_count"
                echo "##vso[task.setvariable variable=commitCount]$commit_count"
                echo "Commit count from variable : ${{ variables.commitCount }}"
            name: commitCounter
  - stage: create_temp_environment
    displayName: Create Temp Environment
    dependsOn: check_pr_commits_count
    jobs:
      - job: create_environment
        displayName: Create Environment
        steps:
          - bash: |
              commit_count=$(echo "$(commitCount)")
              echo "Number of commits in the pull request: $commit_count"
            displayName: Print Commit Count
